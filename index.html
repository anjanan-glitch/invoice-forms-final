<script>
    // Get invoice_id from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const invoiceId = urlParams.get('invoice_id');
    
    document.getElementById('requesterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const form = this;
        const submitBtn = form.querySelector('.submit-btn');
        const loading = form.querySelector('.loading');
        const successMsg = form.querySelector('.success-message');
        const errorMsg = form.querySelector('.error-message');
        
        // Show loading state
        submitBtn.style.display = 'none';
        loading.style.display = 'block';
        successMsg.style.display = 'none';
        errorMsg.style.display = 'none';
        
        // Create form data
        const formData = new FormData(form);
        const data = {};
        for (let [key, value] of formData.entries()) {
            data[key] = value;
        }
        
        // Add timestamp and invoice_id
        data.submission_time = new Date().toISOString();
        data.invoice_id = invoiceId; // Add this line
        
        // Submit to webhook
        fetch(form.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            loading.style.display = 'none';
            
            if (response.ok) {
                successMsg.style.display = 'block';
                form.reset();
                
                // Redirect after 3 seconds
                setTimeout(() => {
                    window.close(); // Try to close the window/tab
                }, 3000);
            } else {
                throw new Error('Network response was not ok');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            loading.style.display = 'none';
            errorMsg.style.display = 'block';
            submitBtn.style.display = 'block';
        });
    });
    
    // Auto-format amount input
    document.getElementById('amount').addEventListener('input', function() {
        let value = this.value;
        if (value && !isNaN(value)) {
            this.value = parseFloat(value).toFixed(2);
        }
    });
</script>
<!-- test rebuild -->
